{% extends "base.html" %}

{% block title %}Executions - Job Scheduler{% endblock %}

{% block content %}
<div class="dashboard-header">
    <h2>Execution History</h2>
</div>

<div class="section">
    <div class="search-container"
        style="margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
        <input type="text" id="job-search" placeholder="Search by job name..."
            style="flex: 1; min-width: 200px; max-width: 400px; padding: 0.5rem; border: 1px solid var(--input-border); border-radius: 4px; font-size: 1rem;">
        <select id="status-filter"
            style="padding: 0.5rem; border: 1px solid var(--input-border); border-radius: 4px; font-size: 1rem; background: var(--input-bg); color: var(--text);">
            <option value="">All Statuses</option>
            <option value="Success">Success</option>
            <option value="Failed">Failed</option>
            <option value="Running">Running</option>
            <option value="Scheduled">Scheduled</option>
        </select>
    </div>
    <div class="table-container">
        <table id="executions-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>PID</th>
                    <th>Task</th>
                    <th>Job</th>
                    <th>Status</th>
                    <th>Start Time</th>
                    <th>End Time</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="executions-body">
                <tr>
                    <td colspan="7" class="loading">Loading...</td>
                </tr>
            </tbody>
        </table>
    </div>
    <div id="pagination" class="pagination"
        style="margin-top: 1rem; display: flex; justify-content: center; align-items: center; gap: 0.5rem;"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let allExecutions = [];
    let currentPage = 1;
    let paginationInfo = null;

    function formatStatus(status) {
        const classes = {
            'Success': 'status-badge success',
            'Failed': 'status-badge failed',
            'Cancelled': 'status-badge cancelled',
            'Running': 'status-badge running',
            'Scheduled': 'status-badge scheduled'
        };
        return `<span class="${classes[status] || 'status-badge'}">${status}</span>`;
    }

    function formatTime(timeStr) {
        if (!timeStr) return '-';
        const date = new Date(timeStr);
        return date.toLocaleString();
    }

    async function deleteExecution(execId) {
        showConfirmModal('Delete Execution', 'Are you sure you want to delete this execution and its logs?', async () => {
            try {
                const response = await fetch(`/api/executions/${execId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadExecutions(currentPage);
                } else {
                    alert('Failed to delete execution');
                }
            } catch (error) {
                console.error('Error deleting execution:', error);
                alert('Error deleting execution');
            }
        });
    }

    async function cancelExecution(execId) {
        showConfirmModal('Cancel Execution', 'Are you sure you want to cancel this running execution?', async () => {
            try {
                const response = await fetch(`/api/executions/${execId}/cancel`, {
                    method: 'POST'
                });

                if (response.ok) {
                    loadExecutions(currentPage);
                } else {
                    alert('Failed to cancel execution');
                }
            } catch (error) {
                console.error('Error cancelling execution:', error);
                alert('Error cancelling execution');
            }
        });
    }

    async function loadExecutions(page = 1) {
        currentPage = page;
        try {
            const response = await fetch(`/api/executions?page=${page}&limit=50`);
            const result = await response.json();
            allExecutions = result.data || result; // Support both new format and old format
            paginationInfo = result.pagination || null;
            filterExecutions();
            updatePagination();
        } catch (error) {
            console.error('Error loading executions:', error);
            document.getElementById('executions-body').innerHTML =
                '<tr><td colspan="7" class="error">Error loading data</td></tr>';
        }
    }

    function updatePagination() {
        const paginationEl = document.getElementById('pagination');
        if (!paginationInfo || paginationInfo.totalPages <= 1) {
            paginationEl.style.display = 'none';
            return;
        }

        paginationEl.style.display = 'flex';
        const page = paginationInfo.page;
        const totalPages = paginationInfo.totalPages;
        const total = paginationInfo.total;

        let html = `<span style="margin-right: 1rem;">Showing ${(page - 1) * paginationInfo.limit + 1}-${Math.min(page * paginationInfo.limit, total)} of ${total}</span>`;

        if (page > 1) {
            html += `<button class="btn btn-sm" onclick="loadExecutions(${page - 1})">Previous</button>`;
        }

        // Show page numbers
        let startPage = Math.max(1, page - 2);
        let endPage = Math.min(totalPages, page + 2);

        if (startPage > 1) {
            html += `<button class="btn btn-sm" onclick="loadExecutions(1)">1</button>`;
            if (startPage > 2) html += `<span>...</span>`;
        }

        for (let p = startPage; p <= endPage; p++) {
            if (p === page) {
                html += `<button class="btn btn-sm" style="background: var(--primary); opacity: 0.8;" disabled>${p}</button>`;
            } else {
                html += `<button class="btn btn-sm" onclick="loadExecutions(${p})">${p}</button>`;
            }
        }

        if (endPage < totalPages) {
            if (endPage < totalPages - 1) html += `<span>...</span>`;
            html += `<button class="btn btn-sm" onclick="loadExecutions(${totalPages})">${totalPages}</button>`;
        }

        if (page < totalPages) {
            html += `<button class="btn btn-sm" onclick="loadExecutions(${page + 1})">Next</button>`;
        }

        paginationEl.innerHTML = html;
    }

    function filterExecutions() {
        const searchTerm = document.getElementById('job-search').value.toLowerCase();
        const statusFilter = document.getElementById('status-filter').value;

        const filtered = allExecutions.filter(exec => {
            const matchesJobName = exec.jobName.toLowerCase().includes(searchTerm);
            const matchesStatus = !statusFilter || exec.status === statusFilter;
            return matchesJobName && matchesStatus;
        });

        const tbody = document.getElementById('executions-body');
        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="no-data">No executions found</td></tr>';
            return;
        }

        tbody.innerHTML = filtered.map(exec => `
            <tr>
                <td>${exec.id}</td>
                <td>${exec.pid}</td>
                <td><a href="/tasks/${exec.taskId}">${exec.taskName}</a></td>
                <td>${exec.jobName}</td>
                <td>${formatStatus(exec.status)}</td>
                <td>${formatTime(exec.startTime)}</td>
                <td>${formatTime(exec.endTime)}</td>
                <td>
                    <a href="/executions/${exec.id}/log" class="btn btn-sm">View Log</a>
                    ${exec.status === 'Running' ? `<button onclick="cancelExecution(${exec.id})" class="btn btn-sm btn-danger">Cancel</button>` : ''}
                    <button onclick="deleteExecution(${exec.id})" class="btn btn-sm btn-danger">Delete</button>
                </td>
            </tr>
        `).join('');
    }

    document.getElementById('job-search').addEventListener('input', filterExecutions);
    document.getElementById('status-filter').addEventListener('change', filterExecutions);

    loadExecutions();
    // Note: Auto-refresh is disabled with pagination to avoid jumping between pages
</script>
{% endblock %}