{% extends "base.html" %}

{% block title %}Dashboard - Job Scheduler{% endblock %}

{% block content %}
<div class="dashboard-header">
    <h2>Dashboard</h2>
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value" id="total-executions">-</div>
            <div class="stat-label">Total Executions</div>
        </div>
        <div class="stat-card success">
            <div class="stat-value" id="successful">-</div>
            <div class="stat-label">Successful</div>
        </div>
        <div class="stat-card running">
            <div class="stat-value" id="running">-</div>
            <div class="stat-label">Running</div>
        </div>
        <div class="stat-card failed">
            <div class="stat-value" id="failed">-</div>
            <div class="stat-label">Failed</div>
        </div>
    </div>
</div>

<div class="section" id="running-section" style="display:none">
    <h3>Currently Running</h3>
    <div class="table-container">
        <table id="running-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Task</th>
                    <th>Job</th>
                    <th>Started</th>
                    <th>Duration</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="running-body"></tbody>
        </table>
    </div>
</div>

<div class="section">
    <h3>Recent Executions</h3>
    <div class="table-container">
        <table id="executions-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Task</th>
                    <th>Job</th>
                    <th>Status</th>
                    <th>Start Time</th>
                    <th>End Time</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="executions-body">
                <tr>
                    <td colspan="7" class="loading">Loading...</td>
                </tr>
            </tbody>
        </table>
    </div>
    <div id="pagination" class="pagination"
        style="margin-top: 1rem; display: flex; justify-content: center; align-items: center; gap: 0.5rem;"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function formatStatus(status) {
        const classes = {
            'Success': 'status-badge success',
            'Failed': 'status-badge failed',
            'Cancelled': 'status-badge cancelled',
            'Running': 'status-badge running',
            'Scheduled': 'status-badge scheduled'
        };
        return `<span class="${classes[status] || 'status-badge'}">${status}</span>`;
    }

    function formatTime(timeStr) {
        if (!timeStr) return '-';
        const date = new Date(timeStr);
        return date.toLocaleString();
    }

    function calculateDuration(startTime) {
        if (!startTime) return '-';
        const diff = new Date() - new Date(startTime);
        const seconds = Math.floor(diff / 1000);
        const minutes = Math.floor(seconds / 60);
        if (minutes > 0) return `${minutes}m ${seconds % 60}s`;
        return `${seconds}s`;
    }

    async function cancelJob(execId) {
        if (!confirm('Are you sure you want to cancel this job?')) return;
        try {
            await fetch(`/api/executions/${execId}/cancel`, { method: 'POST' });
            loadDashboard();
        } catch (e) { console.error(e); alert('Failed to cancel job'); }
    }

    async function deleteExecution(execId) {
        if (!confirm('Are you sure you want to delete this execution and its logs?')) return;

        try {
            const response = await fetch(`/api/executions/${execId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                loadDashboard(currentPage);
            } else {
                alert('Failed to delete execution');
            }
        } catch (error) {
            console.error('Error deleting execution:', error);
            alert('Error deleting execution');
        }
    }

    let currentPage = 1;
    let paginationInfo = null;

    async function loadDashboard(page = 1) {
        currentPage = page;
        try {
            // Fetch stats separately to get Today's stats
            const statsReq = fetch('/api/stats');
            const runningReq = fetch('/api/running-executions');
            const listReq = fetch(`/api/executions?page=${page}&limit=50`);

            const [statsRes, runningRes, listRes] = await Promise.all([statsReq, runningReq, listReq]);

            // Update Stats Cards
            if (statsRes.ok) {
                const stats = await statsRes.json();
                document.getElementById('total-executions').textContent = stats.total;
                document.getElementById('successful').textContent = stats.success;
                document.getElementById('running').textContent = stats.running;
                document.getElementById('failed').textContent = stats.failed;
            }

            // Update List
            const result = await listRes.json();
            const executions = result.data || result;
            paginationInfo = result.pagination || null;
            // Update Running Jobs (from dedicated API)
            if (runningRes.ok) {
                const runningJobs = await runningRes.json();
                const runningSection = document.getElementById('running-section');
                const runningBody = document.getElementById('running-body');
                
                if (runningJobs.length > 0) {
                    runningSection.style.display = 'block';
                    runningBody.innerHTML = runningJobs.map(exec => `
                    <tr>
                        <td>${exec.id}</td>
                        <td><a href="/tasks/${exec.taskId}">${exec.taskName}</a></td>
                        <td>${exec.jobName}</td>
                        <td>${formatTime(exec.startTime)}</td>
                        <td>${calculateDuration(exec.startTime)}</td>
                        <td>
                            <a href="/executions/${exec.id}/log" class="btn btn-sm">View Log</a>
                            <button onclick="cancelJob(${exec.id})" class="btn btn-sm btn-danger">Cancel</button>
                        </td>
                    </tr>
                    `).join('');
                } else {
                    runningSection.style.display = 'none';
                }
            }
            }

            // Update table
            const tbody = document.getElementById('executions-body');
            if (executions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="no-data">No executions found</td></tr>';
                return;
            }

            tbody.innerHTML = executions.map(exec => `
            <tr>
                <td>${exec.id}</td>
                <td><a href="/tasks/${exec.taskId}">${exec.taskName}</a></td>
                <td>${exec.jobName}</td>
                <td>${formatStatus(exec.status)}</td>
                <td>${formatTime(exec.startTime)}</td>
                <td>${formatTime(exec.endTime)}</td>
                <td>
                    <a href="/executions/${exec.id}/log" class="btn btn-sm">View Log</a>
                    <button onclick="deleteExecution(${exec.id})" class="btn btn-sm btn-danger">Delete</button>
                </td>
            </tr>
        `).join('');

            updatePagination();

        } catch (error) {
            console.error('Error loading dashboard:', error);
            document.getElementById('executions-body').innerHTML =
                '<tr><td colspan="7" class="error">Error loading data</td></tr>';
        }
    }

    function updatePagination() {
        const paginationEl = document.getElementById('pagination');
        if (!paginationInfo || paginationInfo.totalPages <= 1) {
            paginationEl.style.display = 'none';
            return;
        }

        paginationEl.style.display = 'flex';
        const page = paginationInfo.page;
        const totalPages = paginationInfo.totalPages;
        const total = paginationInfo.total;

        let html = `<span style="margin-right: 1rem;">Showing ${(page - 1) * paginationInfo.limit + 1}-${Math.min(page * paginationInfo.limit, total)} of ${total}</span>`;

        if (page > 1) {
            html += `<button class="btn btn-sm" onclick="loadDashboard(${page - 1})">Previous</button>`;
        }

        // Show page numbers
        let startPage = Math.max(1, page - 2);
        let endPage = Math.min(totalPages, page + 2);

        if (startPage > 1) {
            html += `<button class="btn btn-sm" onclick="loadDashboard(1)">1</button>`;
            if (startPage > 2) html += `<span>...</span>`;
        }

        for (let p = startPage; p <= endPage; p++) {
            if (p === page) {
                html += `<button class="btn btn-sm" style="background: var(--primary); opacity: 0.8;" disabled>${p}</button>`;
            } else {
                html += `<button class="btn btn-sm" onclick="loadDashboard(${p})">${p}</button>`;
            }
        }

        if (endPage < totalPages) {
            if (endPage < totalPages - 1) html += `<span>...</span>`;
            html += `<button class="btn btn-sm" onclick="loadDashboard(${totalPages})">${totalPages}</button>`;
        }

        if (page < totalPages) {
            html += `<button class="btn btn-sm" onclick="loadDashboard(${page + 1})">Next</button>`;
        }

        paginationEl.innerHTML = html;
    }

    loadDashboard();
    // Note: Auto-refresh disabled with pagination - user can manually refresh if needed
</script>
{% endblock %}